#include <map>
#include <vector>

#include "CentCorrTool.h"

BES2Processing::CentCorrTool::CentCorrTool() {

    PileUpCurve[0][0] = new TF1("TofMultUpper", "[0]+[1]/pow(x, [2])", 0, 850);
    PileUpCurve[0][1] = new TF1("TofMultLower", "[0]+[1]/pow(x, [2])", 0, 850);
    PileUpCurve[1][0] = new TF1("TofMatchUpper", "[0]+[1]/pow(x, [2])", 0, 850);
    PileUpCurve[1][1] = new TF1("TofMatchLower", "[0]+[1]/pow(x, [2])", 0, 850);
    PileUpCurve[2][0] = new TF1("TofBetaUpper", "[0]+[1]/pow(x, [2])", 0, 850);
    PileUpCurve[2][1] = new TF1("TofBetaLower", "[0]+[1]/pow(x, [2])", 0, 850);
    vzPars.clear();
    centSplitEdge.clear();
    centSplitEdgeAlter.clear();
    is27 = false;
    APUUpper = new TF1("AdditionalUpper", "[0]+[1]/pow(x, [2])", 0, 1500);
    APULower = new TF1("AdditionalLower", "[0]+[1]/pow(x, [2])", 0, 1500);
}

void BES2Processing::CentCorrTool::InitParams(const std::string& energy) {
    std::cout << "[LOG] - CentCorrTool: The parameters are for energy tag [" << energy << "]." << std::endl;
    struct PUPars{
        double tofMultUpperPars[3];
        double tofMultLowerPars[3];
        double tofMatchUpperPars[3];
        double tofMatchLowerPars[3];
        double tofBetaUpperPars[3];
        double tofBetaLowerPars[3];
    };

    std::map<std::string, PUPars> dieMap_PU = {
        {"7", {{30.6864, 6.26158, -0.864517}, {-17.7409, 1.27563, -1.0598}, {8.22319, 1.96539, -0.900655}, {-5.58974, 0.29633, -1.15682}, {5.29025, 1.10708, -0.908754}, {-4.76091, 0.239645, -1.09712}}},
        {"9", {{30.2588, 6.38157, -0.870817}, {-18.3055, 1.22498, -1.07414}, {8.22574, 1.96508, -0.904523}, {-6.38592, 0.316951, -1.14702}, {5.68872, 1.13189, -0.903079}, {-5.06023, 0.264804, -1.07645}}},
        {"11", {{27.346, 6.86988, -0.859488}, {-19.1366, 1.32304, -1.06714}, {8.26098, 1.93742, -0.910021}, {-6.75909, 0.352043, -1.13233}, {5.50816, 1.13741, -0.905402}, {-5.11856, 0.271869, -1.07913}}},
        {"14", {{29.2881, 6.57774, -0.882035}, {-19.8953, 1.38664, -1.06884}, {8.54906, 2.01265, -0.913465}, {-6.94971, 0.400689, -1.11989}, {4.65725, 1.22734, -0.892939}, {-5.49198, 0.339053, -1.04094}}},
        {"17", {{26.641, 7.04221, -0.862432}, {-19.7802, 1.28293, -1.07853}, {8.98601, 1.81762, -0.921017}, {-7.14249, 0.360841, -1.12504}, {6.15486, 1.09843, -0.906672}, {-5.29897, 0.300733, -1.0526}}},
        {"19", {{28.8704, 7.18242, -0.871549}, {-23.4178, 1.49167, -1.06679}, {9.74296, 1.9261, -0.92563}, {-8.74082, 0.477894, -1.09509}, {5.76684, 1.17743, -0.901328}, {-5.93035, 0.377975, -1.02556}}},
        {"27", {{32.1665, 7.04665, -0.89009}, {-22.7496, 1.39704, -1.09799}, {9.65873, 1.88415, -0.936989}, {-8.10618, 0.456706, -1.11411}, {6.37227, 1.10729, -0.920705}, {-6.65746, 0.444834, -1.01296}}}
    };
    auto it = dieMap_PU.find(energy);
    if (it != dieMap_PU.end()) {
        for (int i=0; i<3; i++) {
            PileUpCurve[0][0]->SetParameter(i, it->second.tofMultUpperPars[i]);
            PileUpCurve[0][1]->SetParameter(i, it->second.tofMultLowerPars[i]);
            PileUpCurve[1][0]->SetParameter(i, it->second.tofMatchUpperPars[i]);
            PileUpCurve[1][1]->SetParameter(i, it->second.tofMatchLowerPars[i]);
            PileUpCurve[2][0]->SetParameter(i, it->second.tofBetaUpperPars[i]);
            PileUpCurve[2][1]->SetParameter(i, it->second.tofBetaLowerPars[i]);
        }
        std::cout << "[LOG] - CentCorrTool: Pile-up parameters set!" << std::endl;
    } else {
        std::cout << "[WARNING] - CentCorrTool: Pile-up parameters not set for invalid energy tag [" << energy << "]" << std::endl;
    }

    std::map<std::string, std::vector<double>> dieMap_VzC = {
        {"7", {1.03645, 1.03526, 1.03737, 1.03315, 1.03215, 1.03041, 1.02843, 1.02621, 1.0264, 1.02565, 1.02572, 1.02099, 1.0159, 1.0259, 1.01851, 1.01876, 1.02003, 1.01421, 1.01757, 1.01555, 1.01799, 1.01363, 1.01119, 1.01259, 1.00956, 1.01053, 1.00826, 1.00768, 1.00846, 1.00544, 1.00661, 1.00218, 1.00616, 1.00165, 1.00387, 1.00251, 1.00375, 1.00243, 1.0012, 0.999928, 0.99977, 0.998891, 1.00314, 1.00287, 0.997794, 0.997472, 1.00009, 0.999017, 1.00226, 1.00033, 1.00151, 1.00217, 1.0004, 0.996165, 0.998478, 1.00124, 0.999911, 1.00194, 1.00112, 1.00357, 1.00267, 1.00151, 1.00509, 1.00493, 1.00261, 1.00243, 1.00267, 1.00529, 1.0085, 1.00605, 1.00628, 1.00907, 1.00638, 1.00658, 1.01044, 1.01225, 1.01529, 1.01177, 1.01553, 1.01612, 1.01722, 1.0181, 1.01853, 1.01764, 1.01768, 1.02046, 1.0274, 1.02011, 1.02604, 1.02542, 1.0245, 1.03135, 1.02689, 1.03225, 1.0371, 1.03759, 1.03853, 1.03448, 1.04279, 1.03672}},
        {"9", {1.03774, 1.03333, 1.03497, 1.0321, 1.03377, 1.03271, 1.03194, 1.02983, 1.0277, 1.02624, 1.02408, 1.01943, 1.02133, 1.02102, 1.0216, 1.01564, 1.01815, 1.01408, 1.01335, 1.01511, 1.00948, 1.0104, 1.01137, 1.0135, 1.01313, 1.00653, 1.0107, 1.00757, 1.00612, 1.01051, 1.00644, 1.00468, 1.00862, 1.00546, 1.00254, 1.00385, 1.00199, 1.00493, 1.00278, 1.0009, 0.999308, 1.00235, 1.00009, 1.00229, 1.0002, 1.00107, 1.0005, 1.001, 1.00167, 1.00389, 1.00111, 0.999488, 0.999027, 0.999353, 0.998822, 1.00262, 1.00018, 1.00016, 1.00023, 1.00012, 1.00323, 1.00366, 1.00252, 1.00164, 1.00058, 1.00204, 0.999566, 1.00105, 1.00484, 1.00319, 1.00383, 1.00744, 1.00746, 1.00915, 1.01116, 1.00806, 1.01228, 1.00631, 1.01278, 1.01594, 1.01425, 1.01545, 1.01589, 1.01713, 1.01821, 1.01815, 1.01955, 1.02071, 1.01977, 1.02178, 1.02799, 1.02774, 1.02662, 1.02841, 1.02582, 1.02842, 1.02898, 1.03814, 1.03833, 1.03587}},
        {"11", {1.0382, 1.03569, 1.03304, 1.03568, 1.03347, 1.03267, 1.02771, 1.02735, 1.02894, 1.02716, 1.02691, 1.02409, 1.02282, 1.02166, 1.0199, 1.01748, 1.01677, 1.01894, 1.01561, 1.01543, 1.01385, 1.01148, 1.01366, 1.01146, 1.0103, 1.0086, 1.00739, 1.0079, 1.00608, 1.00731, 1.00634, 1.00321, 1.00482, 1.00377, 1.00376, 1.00336, 1.00268, 1.00239, 1.0008, 1.0012, 1.00055, 0.999721, 1.0001, 1.00152, 0.999013, 1.00059, 0.999691, 1.00053, 1.00156, 1.00171, 1.00408, 1.00324, 0.999712, 0.999964, 1.00175, 1.00041, 0.999788, 1.00159, 1.00145, 1.00136, 1.00268, 1.00193, 1.00165, 1.00267, 1.00407, 1.00299, 1.00384, 1.00444, 1.00472, 1.00502, 1.00599, 1.00715, 1.00681, 1.00841, 1.0096, 1.01085, 1.0131, 1.01229, 1.01207, 1.01347, 1.01539, 1.01628, 1.01803, 1.01817, 1.01848, 1.01984, 1.02136, 1.02313, 1.02414, 1.02512, 1.02614, 1.02753, 1.03025, 1.0292, 1.03134, 1.03346, 1.03429, 1.03605, 1.03786, 1.03644}},
        {"14", {1.03706, 1.03683, 1.03403, 1.03156, 1.0323, 1.02819, 1.02723, 1.02773, 1.02745, 1.02507, 1.02389, 1.02154, 1.02034, 1.02016, 1.01903, 1.01719, 1.01678, 1.01553, 1.01312, 1.01469, 1.01219, 1.01282, 1.0104, 1.00812, 1.00926, 1.00807, 1.00637, 1.00706, 1.00617, 1.00536, 1.00483, 1.00516, 1.00283, 1.00477, 1.00326, 1.00231, 1.00177, 1.00161, 1.00093, 1.00151, 0.999966, 1.0016, 1.00078, 0.999286, 1.00067, 0.998992, 1.00003, 1.00048, 1.00185, 1.00121, 1.00283, 0.99909, 1.0005, 1.00186, 1.00185, 0.999594, 1.00094, 1.0021, 0.999929, 1.00174, 1.00109, 1.00172, 1.0023, 1.00419, 1.0046, 1.00482, 1.00421, 1.005, 1.00593, 1.00744, 1.00711, 1.0076, 1.00998, 1.01096, 1.01102, 1.01227, 1.01259, 1.01408, 1.01429, 1.01508, 1.01646, 1.01762, 1.01918, 1.0198, 1.02128, 1.02351, 1.02513, 1.02386, 1.0254, 1.02873, 1.0273, 1.02867, 1.03126, 1.03174, 1.03615, 1.0366, 1.0384, 1.03935, 1.03896, 1.04279}},
        {"17", {1.03685, 1.03736, 1.03237, 1.03557, 1.03214, 1.03194, 1.03054, 1.02833, 1.02848, 1.02648, 1.02545, 1.02439, 1.02257, 1.0219, 1.01944, 1.02, 1.01751, 1.0178, 1.0143, 1.01514, 1.01355, 1.01201, 1.01274, 1.01112, 1.00999, 1.00943, 1.00828, 1.00878, 1.00666, 1.00779, 1.0061, 1.00524, 1.00345, 1.00403, 1.00327, 1.00265, 1.00246, 1.00183, 1.00322, 0.999967, 1.00021, 0.99994, 0.999042, 1.00061, 1.00052, 0.999002, 1.00023, 0.999401, 1.00052, 1.00138, 1.00112, 0.999605, 1.00048, 1.00179, 0.999929, 0.999814, 0.999701, 1.00014, 1.00157, 1.00047, 1.00273, 1.00138, 1.00279, 1.00312, 1.00295, 1.0031, 1.00575, 1.00523, 1.00651, 1.00624, 1.00806, 1.00897, 1.00831, 1.00976, 1.00935, 1.01055, 1.01232, 1.01258, 1.01441, 1.01578, 1.01686, 1.01765, 1.01801, 1.02041, 1.02013, 1.02194, 1.0221, 1.0244, 1.0247, 1.02707, 1.02923, 1.02993, 1.03208, 1.0327, 1.03309, 1.03501, 1.03582, 1.03721, 1.03871, 1.04125}},
        {"19", {1.03761, 1.0361, 1.03501, 1.0338, 1.03169, 1.03171, 1.03035, 1.02902, 1.02767, 1.02461, 1.02576, 1.02291, 1.02162, 1.02027, 1.01839, 1.01791, 1.01675, 1.01574, 1.01436, 1.01377, 1.0129, 1.0118, 1.01046, 1.0112, 1.00986, 1.00883, 1.00767, 1.00705, 1.00581, 1.00652, 1.00483, 1.0046, 1.00374, 1.00265, 1.0027, 1.00153, 1.00014, 1.00199, 1.00161, 1.00059, 1.00082, 1.00187, 1.00026, 1.00018, 0.999571, 1.00057, 1.00089, 0.999902, 1.00143, 1.00313, 1.00074, 0.999743, 1.00034, 0.999992, 1.00174, 1.00114, 1.00138, 1.00091, 1.00029, 1.00251, 1.0033, 1.00255, 1.00335, 1.0032, 1.00484, 1.00516, 1.00406, 1.00528, 1.00619, 1.00624, 1.00726, 1.00757, 1.00998, 1.00968, 1.00992, 1.0126, 1.01279, 1.01448, 1.01591, 1.01504, 1.01688, 1.01867, 1.01758, 1.02079, 1.02187, 1.02317, 1.02442, 1.02517, 1.02506, 1.02656, 1.02865, 1.03087, 1.03303, 1.03381, 1.03378, 1.03605, 1.03673, 1.03926, 1.04012, 1.04158}},
        {"27", {1.04202, 1.03857, 1.03604, 1.03767, 1.03484, 1.03452, 1.02973, 1.03099, 1.02846, 1.02635, 1.02678, 1.0248, 1.02322, 1.02091, 1.02108, 1.01891, 1.01784, 1.01643, 1.01579, 1.01416, 1.01473, 1.01483, 1.01286, 1.01215, 1.01191, 1.01121, 1.00952, 1.00869, 1.0089, 1.00741, 1.00731, 1.00775, 1.007, 1.00703, 1.00649, 1.00606, 1.0056, 1.00391, 1.00358, 1.00352, 1.00353, 1.00349, 1.00393, 1.00244, 1.00218, 1.00244, 1.00255, 1.00158, 1.00077, 1.00123, 1.0026, 1.00133, 1.00043, 1.00043, 1.00035, 0.998961, 0.999626, 0.999217, 1.00018, 0.999169, 0.99988, 0.999686, 1, 0.999717, 0.999807, 0.999998, 0.999526, 0.999702, 0.998612, 0.999434, 0.999664, 1.00081, 0.999978, 1.00069, 1.00069, 1.00002, 1.00074, 1.00071, 1.00058, 1.00094, 1.00126, 1.00294, 1.0018, 1.00429, 1.00531, 1.00568, 1.00561, 1.00656, 1.0078, 1.00885, 1.01015, 1.01098, 1.01224, 1.01242, 1.01555, 1.01538, 1.01367, 1.01529, 1.01765, 1.02079}}
    };
    auto it2 = dieMap_VzC.find(energy);
    if (it2 != dieMap_VzC.end()) {
        vzPars = it2->second;
        std::cout << "[LOG] - CentCorrTool: Vz correction parameters set!" << std::endl;
    } else {
        std::cout << "[WARNING] - CentCorrTool: Vz correction parameters not set for invalid energy tag [" << energy << "]" << std::endl;
    }

    std::map<std::string, std::vector<int>> dieMap_CE = {
        {"7", {376, 310, 212, 142, 92, 56, 32, 17, 8}},
        {"9", {465, 384, 262, 175, 113, 70, 40, 21, 10}},
        {"11", {553, 459, 316, 213, 138, 84, 48, 25, 12}},
        {"14", {625, 520, 359, 243, 158, 97, 55, 29, 14}},
        {"17", {675, 561, 386, 260, 168, 103, 59, 31, 15}},
        {"19", {710, 590, 407, 275, 178, 109, 62, 33, 16}},
        {"27", {494, 409, 279, 187, 121, 74, 42, 22, 11}} // note, this is RefMult3
    };
    auto it3 = dieMap_CE.find(energy);
    if (it3 != dieMap_CE.end()) {
        centSplitEdge = it3->second;
        std::cout << "[LOG] - CentCorrTool: Centrality bin edges set!" << std::endl;
    } else {
        std::cout << "[WARNING] - CentCorrTool:Centrality bin edges not set for invalid energy tag [" << energy << "]" << std::endl;
    }
    std::map<std::string, std::vector<int>> dieMap_CEA = {
        {"7", {414, 369, 329, 294, 263, 236, 212, 190, 170, 152, 136, 121, 108, 96, 85, 76, 67, 59, 51, 45, 39, 34, 29, 25}}, // 24-bin is only activated for 7 GeV
        // {"9", {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}},
        // {"11", {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}},
        // {"14", {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}},
        // {"17", {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}},
        // {"19", {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}},
        // {"27", {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}} 
        {"-1", {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}} 
    };
    auto it4 = dieMap_CEA.find(energy);
    if (it4 != dieMap_CEA.end()) {
        centSplitEdgeAlter = it4->second;
        std::cout << "[LOG] - CentCorrTool: Centrality bin edges (24-bin) set!" << std::endl;
    } else {
        std::cout << "[WARNING] - CentCorrTool:Centrality bin edges (24-bin) not set for invalid energy tag [" << energy << "]" << std::endl;
    }

    is27 = (energy == "27");
    APUUpper->SetParameters(8.76143, 1.28226, -0.972177);
    APULower->SetParameters(-7.25339, 0.804761, -1.00826);
    rd = new TRandom3();
}

int BES2Processing::CentCorrTool::GetCentralityClass9(int ref3) {
    for (int i=0; i<9; i++) {
        if (ref3 > centSplitEdge[i]) {
            return i;
        }
    }
    return -1;
}

int BES2Processing::CentCorrTool::GetCentralityClass24(int ref3) {
    for (int i=0; i<24; i++) {
        if (ref3 > centSplitEdge[i]) {
            return i;
        }
    }
    return -1;
}

bool BES2Processing::CentCorrTool::IsPileUp(int refMult, int tofMult, int tofMatch, int tofBeta) {
    return PileUpCurve[0][0]->Eval(refMult) < tofMult ||
    PileUpCurve[0][1]->Eval(refMult) > tofMult ||
    PileUpCurve[1][0]->Eval(refMult) < tofMatch ||
    PileUpCurve[1][1]->Eval(refMult) > tofMatch ||
    PileUpCurve[2][0]->Eval(refMult) < tofBeta ||
    PileUpCurve[2][1]->Eval(refMult) > tofBeta;
}

int BES2Processing::CentCorrTool::VzCorrection(int ref3, double vz) {
    double factor = 1;
    int vzbin = (int)(vz + 50.0);
    if (vzbin < 0 || vzbin > 99) { return -1; }
    factor = vzPars[vzbin];
    return (int)((ref3 + rd->Rndm()) * factor);
}

int BES2Processing::CentCorrTool::GetCorrectedRefMult3(int ref3, int refMult, int tofMult, int tofMatch, int tofBeta, double vz, int refMult4) {
    if (IsPileUp(refMult, tofMult, tofMatch, tofBeta)) { return -1; }
    ref3 = VzCorrection(ref3, vz);

    // check additional PU for 27 GeV
    // will use the corrected RefMult3
    if (is27) {
        if (refMult4 < APULower->Eval(ref3) || refMult4 > APUUpper->Eval(ref3)) { return -1; }
    }

    return ref3;
}